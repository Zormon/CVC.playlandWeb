import{$,$$$,modalBox2,contentBox,fetchJson,sortJson}from"/js/module-admin.min.js?v4";class RESERVAS{constructor(targetElement,templateElement,searchElement,orderElement=!1){this.target=targetElement,this.template=templateElement,this.search=searchElement,this.order=orderElement,this.json=[]}modal(id=!1){if(id){var item=this.json[id];let html=Mustache.render($("entryModal").innerHTML,item);modalBox2(["Editar compra","var(--color-pink)"],html,[{text:"Borrar",color:"var(--color-red)",action:()=>this.delete(id)},{text:"Editar",color:"var(--color-pink)",size:2,action:()=>this.send(id)}]);var form=$("entryForm");form.elements.equipo.value=item.equipoId,form.elements.entrada.value=item.entradaId,form.elements.pagado.value=item.pagado,form.elements.dia.value=item.dia}else{form=Mustache.render($("entryModal").innerHTML,{});modalBox2(["Nueva compra","var(--color-pink)"],form,[{text:"Confirmar",color:"var(--color-pink)",action:()=>this.send()}])}new Choices($("formEquipo"),{renderChoiceLimit:8})}quickBuyModal(id=0){var html=Mustache.render($("quickBuyModal").innerHTML,{});modalBox2(["Nueva compra rápida","var(--color-cyan)"],html,[{text:"Confirmar",color:"var(--color-cyan)",action:()=>this.sendQuickBuy()}],80,95)}async send(id=!1){if(!$("entryForm").checkValidity())return!1;var entryForm=new FormData($("entryForm")),resp=await fetchJson("/api/taquilla,reservas,"+(id?"edit":"add"),Object.fromEntries(entryForm));switch(Number(resp.status)){case 0:return this.printList(!0),!0;case 1536:return alert("❌ El equipo ya ha pagado para este evento"),!1;default:return alert("❌ "+resp.data),!1}}async sendQuickBuy(){var formEl=$("quickBuyForm");if(!formEl.checkValidity())return formEl.reportValidity(),!1;var formEl=new FormData(formEl),resp=await fetchJson("/api/taquilla,reservas,quickBuy",Object.fromEntries(formEl));switch(Number(resp.status)){case 0:return this.printList(!0),!0;case 1537:return alert("❌ DNI ya registrado"),!1;case 1538:return alert("❌ El equipo 1 ya existe"),!1;case 1539:return alert("❌ El equipo 2 ya existe"),!1;case 1540:return alert("❌ El equipo 3 ya existe"),!1;default:return alert("❌ "+resp.data),!1}}async delete(id){var html=`<p>¿Borrar compra del equipo <em>${this.json[id].equipo}</em>?</p><p><strong>Esto no se puede deshacer</strong></p>`;modalBox2(["Borrar compra","var(--color-red)"],html,[{text:"Borrar",color:"var(--color-red)",action:async()=>{var resp=await fetchJson("/api/taquilla,reservas,delete",{id:id});return 0!==Number(resp.status)?(alert("❌ "+resp.data),!1):(this.printList(!0),!0)}}])}async printList(refresh=!1){if(refresh){var resp=await fetchJson("/api/taquilla,reservas,lista");switch(resp._httpCode){case 200:this.json=resp.data;break;case 204:contentBox(this.target.parentElement,"info","No hay reservas");break;default:alert(`❌ HTTP_CODE: ${data._httpCode}<br>RESPONSE: `+data.data)}}var el,textFilter=this.search.value.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,""),filtered=[];for(el of Object.values(this.json)){var name=el.equipo.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,""),adulto=el.adulto.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");""!=textFilter&&-1==name.search(textFilter)&&-1==adulto.search(textFilter)||filtered.push(el)}this.order&&sortJson(filtered,this.order.value);var children=[];if(0==filtered.length)contentBox(this.target.parentElement,"info","No hay reservas");else{contentBox(this.target.parentElement,"info",!1);for(let item of filtered){let el=document.createElement("li");el.dataset.id=item.id,el.innerHTML=Mustache.render(this.template.innerHTML,item),el.onclick=()=>{this.modal(item.id)},children.push(el)}}this.target.replaceChildren(...children)}}class ADULTOS{constructor(targetElement,templateElement,searchElement,orderElement=!1){this.target=targetElement,this.template=templateElement,this.search=searchElement,this.order=orderElement,this.json=[]}modal(id=!1){if(id){var item=this.json[id];let html=Mustache.render($("entryModal").innerHTML,item);modalBox2(["Editar adulto","var(--color-purple)"],html,[{text:"Borrar",color:"var(--color-red)",action:()=>this.delete(id)},{text:"Editar",color:"var(--color-purple)",size:2,action:()=>this.send(id)}],70),$("entryForm").elements.estado.value=item.estado}else{item=Mustache.render($("entryModal").innerHTML,{});modalBox2(["Nuevo adulto","var(--color-purple)"],item,[{text:"Confirmar",color:"var(--color-purple)",action:()=>this.send()}])}}async send(id=!1){if(!$("entryForm").checkValidity())return!1;var entryForm=new FormData($("entryForm")),data=await fetchJson("/api/taquilla,adultos,"+(id?"edit":"add"),Object.fromEntries(entryForm));switch(Number(data.status)){case 0:return this.printList(!0),!0;case 276:return alert("❌ Ya existe el DNI"),!1;case 277:return alert("❌ Ya existe el email"),!1;case 278:return alert("❌ Ya existe el telefono"),!1;default:return alert("❌ RESPONSE: "+data.data),!1}}async delete(id){var html=`<p>¿Borrar cuenta de <em>${this.json[id].nombre}</em>?</p><p><strong>¡SE BORRARÁN TODOS SUS EQUIPOS ASOCIADOS, RESERVAS Y PARTICIPACIONES DE TODOS LOS EVENTOS!</strong></p>`;modalBox2(["Borrar adulto","var(--color-red)"],html,[{text:"Borrar",color:"var(--color-red)",action:async()=>{var resp=await fetchJson("/api/taquilla,adultos,delete",{id:id});return 0!==Number(resp.status)?(alert("❌ RESPONSE: "+data.data),!1):(this.printList(!0),!0)}}])}async printList(refresh=!1){refresh&&await fetchJson("/api/taquilla,adultos,lista").then(data=>{this.json=data.data});var el,textFilter=this.search.value.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,""),filtered=[];for(el of Object.values(this.json)){var DNI=el.DNI.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,""),nombre=el.nombre.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");""!=textFilter&&-1==DNI.search(textFilter)&&-1==nombre.search(textFilter)||filtered.push(el)}this.order&&sortJson(filtered,this.order.value);var children=[];if(0==filtered.length)contentBox(this.target.parentElement,"info","No hay adultos");else{contentBox(this.target.parentElement,"info",!1);for(let item of filtered){let el=document.createElement("li");el.dataset.id=item.id,el.innerHTML=Mustache.render(this.template.innerHTML,item),el.onclick=()=>{this.modal(item.id)},children.push(el)}}this.target.replaceChildren(...children)}}class EQUIPOS{constructor(targetElement,templateElement,searchElement,orderElement=!1){this.target=targetElement,this.template=templateElement,this.search=searchElement,this.order=orderElement,this.json=[]}modal(id=!1){if(id){var item=this.json[id];item.nacimientoISO=item.nacimiento.split("-").reverse().join("-");let html=Mustache.render($("entryModal").innerHTML,item);modalBox2(["Editar equipo","var(--color-green)"],html,[{text:"Borrar",color:"var(--color-red)",action:()=>this.delete(id)},{text:"Editar",color:"var(--color-green)",size:2,action:()=>this.send(id)}]);var form=$("entryForm");form.elements.adulto.value=item.adultoId,form.elements.bando.value=item.bando}else{form=Mustache.render($("entryModal").innerHTML,{});modalBox2(["Nuevo equipo","var(--color-green)"],form,[{text:"Confirmar",color:"var(--color-green)",action:()=>this.send()}])}new Choices($("formAdulto"),{renderChoiceLimit:6})}async send(id=!1){if(!$("entryForm").checkValidity())return!1;var entryForm=new FormData($("entryForm")),data=await fetchJson("/api/taquilla,equipos,"+(id?"edit":"add"),Object.fromEntries(entryForm));switch(Number(data.status)){case 0:return this.printList(!0),!0;case 1552:return alert("❌ El equipo ya existe"),!1;default:return alert("❌ RESPONSE: "+data),!1}}async delete(id){var html=`<p>¿Borrar equipo <em>${this.json[id].equipo}</em>?</p><p><strong>¡SE BORRARÁN TODAS LAS RESERVAS Y PARTICIPACIONES ASOCIADAS DE TODOS LOS EVENTOS!</strong></p>`;modalBox2(["Borrar equipo","var(--color-red)"],html,[{text:"Borrar",color:"var(--color-red)",action:async()=>{var data=await fetchJson("/api/taquilla,equipos,delete",{id:id});switch(Number(data.status)){case 0:return this.printList(!0),!0;case 1552:return alert("❌ El equipo ya existe"),!1;default:return alert("❌ RESPONSE: "+data),!1}}}])}async printList(refresh=!1){refresh&&await fetchJson("/api/taquilla,equipos,lista").then(data=>{this.json=data.data});var el,textFilter=this.search.value.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,""),filtered=[];for(el of Object.values(this.json)){var titulo=el.titulo.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,""),nombre=el.nombre.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,""),adulto=el.adulto.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");""!=textFilter&&-1==titulo.search(textFilter)&&-1==nombre.search(textFilter)&&-1==adulto.search(textFilter)||filtered.push(el)}this.order&&sortJson(filtered,this.order.value);var children=[];if(0==filtered.length)contentBox(this.target.parentElement,"info","No hay equipos");else{contentBox(this.target.parentElement,"info",!1);for(let item of filtered){let el=document.createElement("li");el.dataset.id=item.id,el.style.borderColor="#"+item.color,el.innerHTML=Mustache.render(this.template.innerHTML,item),el.onclick=()=>{this.modal(item.id)},children.push(el)}}this.target.replaceChildren(...children)}}class PARTICIPACIONES{constructor(targetElement,templateElement,searchElement,orderElement=!1){this.target=targetElement,this.template=templateElement,this.search=searchElement,this.order=orderElement,this.json=[]}modal(id=!1){if(id){var item=this.json[id];let html=Mustache.render($("entryModal").innerHTML,item);modalBox2(["Editar participación","var(--color-yellow)"],html,[{text:"Borrar",color:"var(--color-red)",action:()=>this.delete(id)},{text:"Editar",color:"var(--color-yellow)",size:2,action:()=>this.send(id)}]);var form=$("entryForm");form.elements.equipo.value=item.equipoId,form.elements.prueba.value=item.pruebaId}else{form=Mustache.render($("entryModal").innerHTML,{});modalBox2(["Nueva participación","var(--color-yellow)"],form,[{text:"Confirmar",color:"var(--color-yellow)",action:()=>this.send()}])}new Choices($("formEquipo"),{renderChoiceLimit:6}),new Choices($("formPrueba"),{renderChoiceLimit:7})}async send(id=!1){var entryForm;return!!$("entryForm").checkValidity()&&(entryForm=new FormData($("entryForm")),id&&entryForm.append("id",id),id=await fetchJson("/api/taquilla,participaciones,edit",Object.fromEntries(entryForm)),0!==Number(id.status)?(alert("❌ RESPONSE: "+data),!1):(this.printList(!0),!0))}async delete(id){var el=this.json[id],el=`<p>¿Borrar participación de <em>${el.equipo}</em> en <em>${el.prueba}</em>?</p><p>Fecha: <em>${el.fecha}</em> | Resultado: <em>${el.resultadoISO}</em></p><p><strong>Esto no se puede deshacer</strong></p>`;modalBox2(["Borrar participación","var(--color-red)"],el,[{text:"Borrar",color:"var(--color-red)",action:async()=>{var resp=await fetchJson("/api/taquilla,participaciones,delete",{id:id});return 0!==Number(resp.status)?(alert("❌ RESPONSE: "+data.data),!1):(this.printList(!0),!0)}}])}async printList(refresh=!1){if(refresh){var resp=await fetchJson("/api/taquilla,participaciones,lista");switch(resp._httpCode){case 200:this.json=resp.data;break;case 204:contentBox(this.target.parentElement,"info","No hay participaciones");break;default:alert(`❌ HTTP_CODE: ${data._httpCode}<br>RESPONSE: `+data.data)}}var el,textFilter=this.search.value.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,""),filtered=[];for(el of Object.values(this.json)){switch(el.pruebaTipo){case"puntos":el.resultadoISO=el.resultado;break;case"race":-1==el.resultado?el.resultadoISO="corriendo":el.resultadoISO=new Date(parseInt(el.resultado)).toISOString().slice(14,23);break;default:el.resultadoISO=new Date(parseInt(el.resultado)).toISOString().slice(14,23)}var equipo=el.equipo.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,""),prueba=el.prueba.toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");""!=textFilter&&-1==equipo.search(textFilter)&&-1==prueba.search(textFilter)||filtered.push(el)}this.order&&sortJson(filtered,this.order.value);var children=[];if(0==filtered.length)contentBox(this.target.parentElement,"info","No hay participaciones");else{contentBox(this.target.parentElement,"info",!1);for(let item of filtered){let el=document.createElement("li");el.dataset.id=item.id,el.innerHTML=Mustache.render(this.template.innerHTML,item),el.onclick=()=>{this.modal(item.id)},children.push(el)}}this.target.replaceChildren(...children)}}class LOGIN{static init(){$("loginForm").onsubmit=e=>{e.preventDefault();e={user:$("user").value,pass:$("pass").value};return fetchJson("/api/admin,login",e).then(data=>{switch(Number(data.status)){case 0:location="/taquilla";break;case 1281:alert("❌ Sin usuario");break;case 1282:alert("❌ Sin pass");break;case 1283:alert("❌ Credenciales inválidas");break;default:alert(`❌ HTTP_CODE: ${data._httpCode}<br>RESPONSE: `+data.data)}}),!1}}}export{RESERVAS,ADULTOS,EQUIPOS,PARTICIPACIONES,LOGIN};
//# sourceMappingURL=module-taquilla.min.js.map